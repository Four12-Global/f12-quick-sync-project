(()=>{var u=(e,t,n)=>new Promise((i,r)=>{var a=l=>{try{o(n.next(l))}catch(d){r(d)}},p=l=>{try{o(n.throw(l))}catch(d){r(d)}},o=l=>l.done?i(l.value):Promise.resolve(l.value).then(a,p);o((n=n.apply(e,t)).next())});var g=e=>console.log(`[${new Date().toISOString()}]`,e),M=["publish","draft","trash","private"],F="API-SYNC",$="last_synced";function x(e,t=F){if(!e||!e.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}function N(e){let t=new Set;for(let n in e){let i=e[n];typeof i=="string"?t.add(n):(t.add(i.airtableIdField),i.airtableLinkField&&t.add(i.airtableLinkField))}return t.add("wp_id").add("series_sku").add("series_title"),[...t]}function K(e){return e==null?null:Array.isArray(e)?e.map(t=>typeof t=="object"&&t!==null&&"name"in t?t.name:String(t)):typeof e=="object"&&e.url?e.url:typeof e=="object"&&e!==null&&"name"in e?e.name:e}function R(e,t){let n=e.parentTable,i={};for(let r in t){let a=t[r];if(typeof a=="string"){let o=e.getCellValue(r);a==="post_status"?i.post_status=o&&o.name?o.name.toLowerCase():typeof o=="string"?o.toLowerCase():null:i[a]=K(o);continue}let p=e.getCellValue(a.airtableIdField)||a.airtableLinkField&&e.getCellValue(a.airtableLinkField);p&&(i[a.wpKey]=p)}return i}function D(e,t,n){return u(this,null,function*(){let i=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${t}`},body:JSON.stringify(n)}),r=yield i.text();if(!i.ok)throw new Error(`HTTP ${i.status}: ${r.slice(0,500)}`);return JSON.parse(r)})}function T(e){return u(this,null,function*(){var f,b,k,w,S,h;let{airtableTable:t,fieldMap:n,envEndpoints:i,allowedStatuses:r=M,secretName:a=F}=e,{recordId:p,env:o="prod"}=input.config();if(!p)throw new Error("Automation must pass {recordId}.");let l=i[o]||i.prod,d=Math.floor(Date.now()/1e3);g(`Quick-Sync (${t}) start \u2013 epoch ${d}`);let E=yield input.secret(a),L=x(E,a),A=base.getTable(t),I=N(n),c=yield A.selectRecordAsync(p,{fields:I});if(!c)throw new Error(`Record ${p} not found in ${t}`);let s=R(c,n);(f=s.sku)!=null||(s.sku=c.getCellValueAsString("series_sku")),(b=s.post_title)!=null||(s.post_title=c.getCellValueAsString("series_title")||c.name),s[$]=d,s.post_status&&!r.includes(s.post_status)&&delete s.post_status;let m={airtableRecordId:c.id,sku:s.sku,wp_id:c.getCellValue("wp_id")||null,fields:s};output.set("payloadSent",JSON.stringify(m,null,2).slice(0,2500)),g(`POSTing to ${l}`);let _=yield D(l,L,m),C=(w=_.post_id)!=null?w:(k=_==null?void 0:_.data)==null?void 0:k.post_id,y=(S=_.action)!=null?S:"unknown",v=(h=_.message)!=null?h:"";output.set("syncStatus","Success"),output.set("action",y),output.set("message",v),output.set("postTitle",s.post_title),output.set("wpPostId",C),g(`\u2705 WP ${y} \u2013  ${s.post_title}`)})}var O={series_title:"post_title",series_slug:"post_name",long_date:"post_date",website_status:"post_status",series_sku:"sku",excerpt:"post_excerpt",series_permalink:"custom_permalink_uri",global_categories:"global-categories",series_filter_category:"series-categories",topics:"topics",series_template:"series-templates",featured_image:{airtableIdField:"featured_image_wp_id",airtableLinkField:"featured_image_link",wpKey:"_thumbnail_id"},listing_image:{airtableIdField:"listing_image_wp_id",airtableLinkField:"listing_image_link",wpKey:"listing-image"},no_words_image:{airtableIdField:"no_words_image_wp_id",airtableLinkField:"no_words_image_link",wpKey:"no-words-image"},banner_image:{airtableIdField:"banner_image_wp_id",airtableLinkField:"banner_image_link",wpKey:"banner-image"},primary_cta_image:{airtableIdField:"primary_cta_image_wp_id",airtableLinkField:"primary_cta_image_link",wpKey:"manual1-image"},series_description_title:"series-description_title",series_description:"series-description",who_is_it_for:"series-who-is-it-for",series_purpose:"series-purpose",series_colour_1:"series-colour-1",series_colour_2:"series-colour-2",print_pdf_link:"link_five",custom_pdf_link:"link_ten",youtube_playlist:"youtube-playlist-link",spotify_playlist:"spotify-playlist-link",apple_playlist:"apple-playlist-link",highlights_video:"highlights-video",primary_cta_heading:"manual1-title",primary_cta_title:"manual1-link-title",primary_cta_link:"manual1-link",secondary_cta_heading:"manual2-title",secondary_cta_title:"manual2-link-title",secondary_cta_link:"manual2-link",seo_description:"_aioseo_description",session_title:"custom-session-title",sessions_list:"series-episode-list",session_list_1:"series-episode-list-more",session_list_2:"series-episode-list-3",session_list_3:"series-episode-list-4"};T({airtableTable:"Series",fieldMap:O,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/series-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/series-sync"}});})();
