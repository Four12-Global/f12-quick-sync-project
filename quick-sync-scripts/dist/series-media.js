"use strict";(()=>{var $="API-SYNC";function E(e,t=$){if(!e||!e.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}var f=e=>console.log(`[${new Date().toISOString()}]`,e),v="API-SYNC";async function k(e){var o,c;let t=await fetch(e.url);if(!t.ok)throw new Error(`\u2198 download ${e.url} \u2192 HTTP ${t.status}`);return{blob:await t.blob(),filename:(o=e.filename)!=null?o:"file",contentType:(c=t.headers.get("content-type"))!=null?c:"application/octet-stream",srcUrl:e.url}}async function M(e,t,{blob:o,filename:c,contentType:d}){let a=await fetch(e,{method:"POST",headers:{Authorization:`Basic ${t}`,"Content-Type":d,"Content-Disposition":`attachment; filename="${c}"`},body:o}),l=await a.json();if(!a.ok||!(l!=null&&l.id))throw new Error(`\u2197 WP upload failed ${a.status}: ${JSON.stringify(l).slice(0,200)}`);return{id:String(l.id),url:l.source_url}}async function A(e,t,o,c,d){var w,S,C,F,T;let a=(w=e.getCellValue(t.attachmentField))!=null?w:[],l=(S=e.getCellValue(t.wpIdField))!=null?S:"",m=(C=e.getCellValue(t.wpUrlField))!=null?C:"",y=(F=e.getCellValue(t.airtableCacheField))!=null?F:"",p=t.externalUrlField?(((T=e.getCellValueAsString)==null?void 0:T.call(e,t.externalUrlField))||"").trim():"";if(a.length===0&&p)return{wpIds:null,wpUrls:p,cacheUrls:null,changed:p!==m};if(a.length===0)return l||m||y?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!t.isMultiple){let i=a[0],n=i.url;if(n===y&&l)return{changed:!1};try{let{blob:s,filename:u,contentType:h}=await k(i),{id:b,url:_}=await M(o,c,{blob:s,filename:u,contentType:h});return{wpIds:b,wpUrls:_,cacheUrls:n,changed:!0}}catch(s){return d&&d(s),f(`\u26A0\uFE0F  single-upload failed ${i.url}: ${s.message}`),{changed:!1}}}if(t.isMultiple){let i=[];for(let n of a)try{let{blob:s,filename:u,contentType:h}=await k(n),{id:b,url:_}=await M(o,c,{blob:s,filename:u,contentType:h});i.push({id:b,url:_})}catch(s){d&&d(s),f(`\u274C  multi\u2011upload failed ${n.url}: ${s.message}`)}return i.length?{wpIds:i.map(n=>n.id).join(","),wpUrls:i.map(n=>n.url).join(","),cacheUrls:a.map(n=>n.url).join(","),changed:!0}:{changed:!1}}return{changed:!1}}async function U(e,t){var b,_,I;let o=!1,{airtableTable:c,envMediaEndpoints:d,imageFields:a,lastModifiedField:l,publishTimestampField:m,secretName:y=v}=e,{recordId:p,env:w}=t;if(!p)throw new Error("Automation must pass {recordId}.");if(!w||!d[w]){let r=Object.keys(d).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${r}`)}let S=d[w],C=E(await input.secret(y),y),F=base.getTable(c),T=[l,m,...a.flatMap(r=>[r.attachmentField,r.wpIdField,r.wpUrlField,r.airtableCacheField])],i=await F.selectRecordAsync(p,{fields:T});if(!i)throw new Error(`Record ${p} not found.`);let n=i.getCellValue(l),s=i.getCellValue(m);if(n&&s&&Date.parse(n)<=Date.parse(s)){f("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let u={},h=!1;for(let r of a)try{let g=await A(i,r,S,C,V=>{o=!0});g&&g.changed&&(u[r.wpIdField]=(b=g.wpIds)!=null?b:null,u[r.wpUrlField]=(_=g.wpUrls)!=null?_:null,u[r.airtableCacheField]=(I=g.cacheUrls)!=null?I:null,h=!0)}catch(g){o=!0,f(`\u26A0\uFE0F  ${r.attachmentField}: ${g.message}`)}h?(o?f("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):u[m]=new Date().toISOString(),await F.updateRecordAsync(i,u),f("\u2705\xA0Media sync complete & fields updated")):f("\u2714\xA0No media changes detected \u2013 nothing to write")}var x=input.config(),N={airtableTable:"Series",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"featured_image_attachment",wpIdField:"featured_image_wp_id",wpUrlField:"featured_image_link",airtableCacheField:"featured_image_external",isMultiple:!1},{attachmentField:"banner_image_attachment",wpIdField:"banner_image_wp_id",wpUrlField:"banner_image_link",airtableCacheField:"banner_image_external",isMultiple:!1},{attachmentField:"listing_image_attachment",wpIdField:"listing_image_wp_id",wpUrlField:"listing_image_link",airtableCacheField:"listing_image_external",isMultiple:!1},{attachmentField:"no_words_image_attachment",wpIdField:"no_words_image_wp_id",wpUrlField:"no_words_image_link",airtableCacheField:"no_words_image_external",isMultiple:!1},{attachmentField:"primary_cta_image_attachment",wpIdField:"primary_cta_image_wp_id",wpUrlField:"primary_cta_image_link",airtableCacheField:"primary_cta_image_external",isMultiple:!1}]};U(N,x);})();
