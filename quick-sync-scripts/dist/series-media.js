"use strict";(()=>{var $="API-SYNC";function U(e,t=$){if(!e||!e.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}var g=e=>console.log(`[${new Date().toISOString()}]`,e),A="API-SYNC";async function E(e){var d,r;let t=await fetch(e.url);if(!t.ok)throw new Error(`\u2198 download ${e.url} \u2192 HTTP ${t.status}`);return{blob:await t.blob(),filename:(d=e.filename)!=null?d:"file",contentType:(r=t.headers.get("content-type"))!=null?r:"application/octet-stream",srcUrl:e.url}}async function M(e,t,{blob:d,filename:r,contentType:c}){let l=await fetch(e,{method:"POST",headers:{Authorization:`Basic ${t}`,"Content-Type":c,"Content-Disposition":`attachment; filename="${r}"`},body:d}),a=await l.json();if(!l.ok||!(a!=null&&a.id))throw new Error(`\u2197 WP upload failed ${l.status}: ${JSON.stringify(a).slice(0,200)}`);return{id:String(a.id),url:a.source_url}}async function x(e,t,d,r,c){var S,C,y,T,u;let l=(S=e.getCellValue(t.attachmentField))!=null?S:[],a=(C=e.getCellValue(t.wpIdField))!=null?C:"",F=(y=e.getCellValue(t.wpUrlField))!=null?y:"",f=(T=e.getCellValue(t.airtableCacheField))!=null?T:"",b=t.externalUrlField?(((u=e.getCellValueAsString)==null?void 0:u.call(e,t.externalUrlField))||"").trim():"";if(l.length===0&&b)return{wpIds:null,wpUrls:b,cacheUrls:null,changed:b!==F};if(l.length===0)return a||F||f?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!t.isMultiple){let s=l[0],n=s.url;if(n===f&&a)return{changed:!1};try{let{blob:i,filename:m,contentType:w}=await E(s),{id:h,url:_}=await M(d,r,{blob:i,filename:m,contentType:w});return{wpIds:h,wpUrls:_,cacheUrls:n,changed:!0}}catch(i){return c&&c(i),g(`\u26A0\uFE0F  single-upload failed ${s.url}: ${i.message}`),{changed:!1}}}if(t.isMultiple){let s=[];for(let n of l)try{let{blob:i,filename:m,contentType:w}=await E(n),{id:h,url:_}=await M(d,r,{blob:i,filename:m,contentType:w});s.push({id:h,url:_})}catch(i){c&&c(i),g(`\u274C  multi\u2011upload failed ${n.url}: ${i.message}`)}return s.length?{wpIds:s.map(n=>n.id).join(","),wpUrls:s.map(n=>n.url).join(","),cacheUrls:l.map(n=>n.url).join(","),changed:!0}:{changed:!1}}return{changed:!1}}async function k(e){var w,h,_,I;let t=!1,{airtableTable:d,envMediaEndpoints:r,imageFields:c,lastModifiedField:l,publishTimestampField:a,secretName:F=A}=e,{recordId:f,env:b="prod"}=input.config();if(!f)throw new Error("Automation must pass {recordId}.");let S=(w=r[b])!=null?w:r.prod,C=U(await input.secret(F),F),y=base.getTable(d),T=[l,a,...c.flatMap(o=>[o.attachmentField,o.wpIdField,o.wpUrlField,o.airtableCacheField])],u=await y.selectRecordAsync(f,{fields:T});if(!u)throw new Error(`Record ${f} not found.`);let s=u.getCellValue(l),n=u.getCellValue(a);if(s&&n&&Date.parse(s)<=Date.parse(n)){g("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let i={},m=!1;for(let o of c)try{let p=await x(u,o,S,C,N=>{t=!0});p&&p.changed&&(i[o.wpIdField]=(h=p.wpIds)!=null?h:null,i[o.wpUrlField]=(_=p.wpUrls)!=null?_:null,i[o.airtableCacheField]=(I=p.cacheUrls)!=null?I:null,m=!0)}catch(p){t=!0,g(`\u26A0\uFE0F  ${o.attachmentField}: ${p.message}`)}m?(t?g("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):i[a]=new Date().toISOString(),await y.updateRecordAsync(u,i),g("\u2705\xA0Media sync complete & fields updated")):g("\u2714\xA0No media changes detected \u2013 nothing to write")}var v={airtableTable:"Series",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"featured_image_attachment",wpIdField:"featured_image_wp_id",wpUrlField:"featured_image_link",airtableCacheField:"featured_image_external",isMultiple:!1},{attachmentField:"banner_image_attachment",wpIdField:"banner_image_wp_id",wpUrlField:"banner_image_link",airtableCacheField:"banner_image_external",isMultiple:!1},{attachmentField:"listing_image_attachment",wpIdField:"listing_image_wp_id",wpUrlField:"listing_image_link",airtableCacheField:"listing_image_external",isMultiple:!1},{attachmentField:"no_words_image_attachment",wpIdField:"no_words_image_wp_id",wpUrlField:"no_words_image_link",airtableCacheField:"no_words_image_external",isMultiple:!1},{attachmentField:"primary_cta_image_attachment",wpIdField:"primary_cta_image_wp_id",wpUrlField:"primary_cta_image_link",airtableCacheField:"primary_cta_image_external",isMultiple:!1}]};k(v);})();
