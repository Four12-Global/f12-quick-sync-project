"use strict";(()=>{var N="API-SYNC";function U(e,i=N){if(!e||!e.includes(":"))throw new Error(`Secret "${i}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}var c=e=>console.log(`[${new Date().toISOString()}]`,e);async function P(e){let i=new Map;if(e.fields&&Array.isArray(e.fields))for(let d of e.fields)d.id&&d.name&&i.set(d.id,d.name);return i}var R="API-SYNC";async function A(e){var d,u;let i=await fetch(e.url);if(!i.ok)throw new Error(`\u2198 download ${e.url} \u2192 HTTP ${i.status}`);return{blob:await i.blob(),filename:(d=e.filename)!=null?d:"file",contentType:(u=i.headers.get("content-type"))!=null?u:"application/octet-stream",srcUrl:e.url}}async function v(e,i,{blob:d,filename:u,contentType:w},p){c(`Uploading ${u}${p?` for record ${p}`:""} \u2026`);try{let n=await fetch(e,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":w,"Content-Disposition":`attachment; filename="${u}"`},body:d}),r=await n.json();if(!n.ok||!(r!=null&&r.id))throw new Error(`\u2197 WP upload failed ${n.status}: ${JSON.stringify(r).slice(0,200)}`);return c(`\u2705 Uploaded ${u} \u2192 ${r.source_url} (wpId: ${r.id})`),{id:String(r.id),url:r.source_url}}catch(n){throw console.error(`\u274C Upload failed ${u}${p?` for record ${p}`:""}: ${n.message}`),n}}async function V(e,i,d,u,w,p){var I,_,C,T,h,S,$;let n=(I=e.getCellValue(i.attachmentField))!=null?I:[],r=(_=e.getCellValue(i.wpIdField))!=null?_:"",b=(C=e.getCellValue(i.wpUrlField))!=null?C:"",m=(T=e.getCellValue(i.airtableCacheField))!=null?T:"",f=(m!=null?m:"").split(",").filter(Boolean),F=i.externalUrlField?(((h=e.getCellValueAsString)==null?void 0:h.call(e,i.externalUrlField))||"").trim():"";if(n.length===0&&F)return{wpIds:null,wpUrls:F,cacheUrls:null,changed:F!==b};if(n.length===0)return r||b||m?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!i.isMultiple){let a=n[0];if(f.includes(a.id)&&r)return c(`\u21A9\uFE0F Reusing ${(S=a.filename)!=null?S:"file"} (wpId: ${r})`),{changed:!1};try{let{blob:o,filename:g,contentType:y}=await A(a),{id:s,url:t}=await v(d,u,{blob:o,filename:g,contentType:y},w);return{wpIds:s,wpUrls:t,cacheUrls:a.id,changed:!0}}catch(o){return p&&p(o),c(`\u26A0\uFE0F  single-upload failed ${a.url}: ${o.message}`),{changed:!1}}}if(i.isMultiple){let a=[];for(let o of n){if(f.includes(o.id)){c(`\u21A9\uFE0F Reusing ${($=o.filename)!=null?$:"file"}\u2026`);continue}try{let{blob:g,filename:y,contentType:s}=await A(o),{id:t,url:l}=await v(d,u,{blob:g,filename:y,contentType:s},w);a.push({id:t,url:l,airtableId:o.id})}catch(g){p&&p(g),c(`\u274C  multi\u2011upload failed ${o.url}: ${g.message}`)}}if(a.length||n.some(o=>f.includes(o.id))){let o=n.filter(s=>f.includes(s.id)).map(s=>s.id),g=r.split(",").filter(Boolean).filter((s,t)=>{var l;return f.includes((l=n[t])==null?void 0:l.id)}),y=b.split(",").filter(Boolean).filter((s,t)=>{var l;return f.includes((l=n[t])==null?void 0:l.id)});return{wpIds:[...g,...a.map(s=>s.id)].join(","),wpUrls:[...y,...a.map(s=>s.url)].join(","),cacheUrls:[...o,...a.map(s=>s.airtableId)].join(","),changed:!0}}return{changed:!1}}return{changed:!1}}async function x(e,i){var g,y,s;let d=!1,{airtableTable:u,envMediaEndpoints:w,imageFields:p,lastModifiedField:n,publishTimestampField:r,secretName:b=R}=e,{recordId:m,env:f}=i;if(!m)throw new Error("Automation must pass {recordId}.");if(!f||!w[f]){let t=Object.keys(w).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${t}`)}let F=w[f],I=U(await input.secret(b),b),_=base.getTable(u),C=await P(_),T=[n,r,...p.flatMap(t=>[t.attachmentField,t.wpIdField,t.wpUrlField,t.airtableCacheField])],h=await _.selectRecordAsync(m,{fields:T});if(!h)throw new Error(`Record ${m} not found.`);let S=h.getCellValue(n),$=h.getCellValue(r);if(S&&$&&Date.parse(S)<=Date.parse($)){c("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let a={},o=!1;for(let t of p)try{let l=await V(h,t,F,I,m,E=>{d=!0});l&&l.changed&&(a[t.wpIdField]=(g=l.wpIds)!=null?g:null,a[t.wpUrlField]=(y=l.wpUrls)!=null?y:null,a[t.airtableCacheField]=(s=l.cacheUrls)!=null?s:null,o=!0)}catch(l){d=!0,c(`\u26A0\uFE0F  Error processing field spec "${t.attachmentField}": ${l.message}`)}if(o){d?c("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):a[r]=new Date().toISOString();try{await _.updateRecordAsync(h,a),c("\u2705\xA0Media sync complete & fields updated")}catch(t){let l=t.message,E=l.match(/Field "(.+?)"/);if(E&&E[1]){let M=E[1],k=`Error updating Airtable: The field "${C.get(M)||"Unknown Field"}" (ID: ${M}) could not accept the value provided by the script. Please verify its field type.`;throw c(`\u274C ${k}`),new Error(k)}throw c(`\u274C An unexpected error occurred while updating Airtable: ${l}`),t}}else c("\u2714\xA0No media changes detected \u2013 nothing to write")}var L=input.config(),O={airtableTable:"Series",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com//wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"featured_image_attachment",wpIdField:"featured_image_wp_id",wpUrlField:"featured_image_link",airtableCacheField:"featured_image_external",isMultiple:!1},{attachmentField:"banner_image_attachment",wpIdField:"banner_image_wp_id",wpUrlField:"banner_image_link",airtableCacheField:"banner_image_external",isMultiple:!1},{attachmentField:"listing_image_attachment",wpIdField:"listing_image_wp_id",wpUrlField:"listing_image_link",airtableCacheField:"listing_image_external",isMultiple:!1},{attachmentField:"no_words_image_attachment",wpIdField:"no_words_image_wp_id",wpUrlField:"no_words_image_link",airtableCacheField:"no_words_image_external",isMultiple:!1},{attachmentField:"primary_cta_image_attachment",wpIdField:"primary_cta_image_wp_id",wpUrlField:"primary_cta_image_link",airtableCacheField:"primary_cta_image_external",isMultiple:!1}]};x(O,L);})();
