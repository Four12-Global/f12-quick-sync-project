"use strict";(()=>{var v="API-SYNC";function E(t,i=v){if(!t||!t.includes(":"))throw new Error(`Secret "${i}" must be "user:app-password".`);return Buffer.from(t).toString("base64")}var p=t=>console.log(`[${new Date().toISOString()}]`,t),A="API-SYNC";async function k(t){var c,o;let i=await fetch(t.url);if(!i.ok)throw new Error(`\u2198 download ${t.url} \u2192 HTTP ${i.status}`);return{blob:await i.blob(),filename:(c=t.filename)!=null?c:"file",contentType:(o=i.headers.get("content-type"))!=null?o:"application/octet-stream",srcUrl:t.url}}async function U(t,i,{blob:c,filename:o,contentType:m},d){p(`Uploading ${o}${d?` for record ${d}`:""} \u2026`);try{let n=await fetch(t,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":m,"Content-Disposition":`attachment; filename="${o}"`},body:c}),a=await n.json();if(!n.ok||!(a!=null&&a.id))throw new Error(`\u2197 WP upload failed ${n.status}: ${JSON.stringify(a).slice(0,200)}`);return p(`\u2705 Uploaded ${o} \u2192 ${a.source_url} (wpId: ${a.id})`),{id:String(a.id),url:a.source_url}}catch(n){throw console.error(`\u274C Upload failed ${o}${d?` for record ${d}`:""}: ${n.message}`),n}}async function x(t,i,c,o,m,d){var I,S,T,w,C,$,h;let n=(I=t.getCellValue(i.attachmentField))!=null?I:[],a=(S=t.getCellValue(i.wpIdField))!=null?S:"",b=(T=t.getCellValue(i.wpUrlField))!=null?T:"",f=(w=t.getCellValue(i.airtableCacheField))!=null?w:"",g=(f!=null?f:"").split(",").filter(Boolean),F=i.externalUrlField?(((C=t.getCellValueAsString)==null?void 0:C.call(t,i.externalUrlField))||"").trim():"";if(n.length===0&&F)return{wpIds:null,wpUrls:F,cacheUrls:null,changed:F!==b};if(n.length===0)return a||b||f?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!i.isMultiple){let s=n[0];if(g.includes(s.id)&&a)return p(`\u21A9\uFE0F Reusing ${($=s.filename)!=null?$:"file"} (wpId: ${a})`),{changed:!1};try{let{blob:l,filename:u,contentType:y}=await k(s),{id:e,url:r}=await U(c,o,{blob:l,filename:u,contentType:y},m);return{wpIds:e,wpUrls:r,cacheUrls:s.id,changed:!0}}catch(l){return d&&d(l),p(`\u26A0\uFE0F  single-upload failed ${s.url}: ${l.message}`),{changed:!1}}}if(i.isMultiple){let s=[];for(let l of n){if(g.includes(l.id)){p(`\u21A9\uFE0F Reusing ${(h=l.filename)!=null?h:"file"}\u2026`);continue}try{let{blob:u,filename:y,contentType:e}=await k(l),{id:r,url:_}=await U(c,o,{blob:u,filename:y,contentType:e},m);s.push({id:r,url:_,airtableId:l.id})}catch(u){d&&d(u),p(`\u274C  multi\u2011upload failed ${l.url}: ${u.message}`)}}if(s.length||n.some(l=>g.includes(l.id))){let l=n.filter(e=>g.includes(e.id)).map(e=>e.id),u=a.split(",").filter(Boolean).filter((e,r)=>{var _;return g.includes((_=n[r])==null?void 0:_.id)}),y=b.split(",").filter(Boolean).filter((e,r)=>{var _;return g.includes((_=n[r])==null?void 0:_.id)});return{wpIds:[...u,...s.map(e=>e.id)].join(","),wpUrls:[...y,...s.map(e=>e.url)].join(","),cacheUrls:[...l,...s.map(e=>e.airtableId)].join(","),changed:!0}}return{changed:!1}}return{changed:!1}}async function M(t,i){var l,u,y;let c=!1,{airtableTable:o,envMediaEndpoints:m,imageFields:d,lastModifiedField:n,publishTimestampField:a,secretName:b=A}=t,{recordId:f,env:g}=i;if(!f)throw new Error("Automation must pass {recordId}.");if(!g||!m[g]){let e=Object.keys(m).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${e}`)}let F=m[g],I=E(await input.secret(b),b),S=base.getTable(o),T=[n,a,...d.flatMap(e=>[e.attachmentField,e.wpIdField,e.wpUrlField,e.airtableCacheField])],w=await S.selectRecordAsync(f,{fields:T});if(!w)throw new Error(`Record ${f} not found.`);let C=w.getCellValue(n),$=w.getCellValue(a);if(C&&$&&Date.parse(C)<=Date.parse($)){p("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let h={},s=!1;for(let e of d)try{let r=await x(w,e,F,I,f,_=>{c=!0});r&&r.changed&&(h[e.wpIdField]=(l=r.wpIds)!=null?l:null,h[e.wpUrlField]=(u=r.wpUrls)!=null?u:null,h[e.airtableCacheField]=(y=r.cacheUrls)!=null?y:null,s=!0)}catch(r){c=!0,p(`\u26A0\uFE0F  ${e.attachmentField}: ${r.message}`)}s?(c?p("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):h[a]=new Date().toISOString(),await S.updateRecordAsync(w,h),p("\u2705\xA0Media sync complete & fields updated")):p("\u2714\xA0No media changes detected \u2013 nothing to write")}var N=input.config(),R={airtableTable:"Series",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com//wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"featured_image_attachment",wpIdField:"featured_image_wp_id",wpUrlField:"featured_image_link",airtableCacheField:"featured_image_external",isMultiple:!1},{attachmentField:"banner_image_attachment",wpIdField:"banner_image_wp_id",wpUrlField:"banner_image_link",airtableCacheField:"banner_image_external",isMultiple:!1},{attachmentField:"listing_image_attachment",wpIdField:"listing_image_wp_id",wpUrlField:"listing_image_link",airtableCacheField:"listing_image_external",isMultiple:!1},{attachmentField:"no_words_image_attachment",wpIdField:"no_words_image_wp_id",wpUrlField:"no_words_image_link",airtableCacheField:"no_words_image_external",isMultiple:!1},{attachmentField:"primary_cta_image_attachment",wpIdField:"primary_cta_image_wp_id",wpUrlField:"primary_cta_image_link",airtableCacheField:"primary_cta_image_external",isMultiple:!1}]};M(R,N);})();
