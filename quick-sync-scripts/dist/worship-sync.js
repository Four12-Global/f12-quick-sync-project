"use strict";(()=>{var y=i=>console.log(`[${new Date().toISOString()}]`,i),j=["publish","draft","trash","private"],I="API-SYNC",V="last_synced";function D(i,t=I){if(!i||!i.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(i).toString("base64")}function K(i,t,n){let e=new Set;for(let r in i){let s=i[r];typeof s=="string"?e.add(r):(e.add(s.airtableIdField),s.airtableLinkField&&e.add(s.airtableLinkField))}return e.add("wp_id").add(t).add(n),Array.from(e)}function W(i,t){return t==null?null:Array.isArray(t)?t.map(n=>typeof n=="object"&&n!==null&&"name"in n?n.name:String(n)):typeof t=="object"&&t.url?t.url:typeof t=="object"&&t!==null&&"name"in t?t.name:t}function q(i,t){let n=i.parentTable,e={};for(let r in t){let s=t[r];if(typeof s=="string"){let c=i.getCellValue(r);s==="post_status"?e.post_status=c&&c.name?c.name.toLowerCase():typeof c=="string"?c.toLowerCase():null:e[s]=W(r,c);continue}let a=i.getCellValue(s.airtableIdField)||s.airtableLinkField&&i.getCellValue(s.airtableLinkField);a&&(e[s.wpKey]=a)}return e}async function B(i,t,n){let e=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${t}`},body:JSON.stringify(n)}),r=await e.text();if(!e.ok)throw new Error(`HTTP ${e.status}: ${r.slice(0,500)}`);return{data:JSON.parse(r),status:e.status}}async function L(i,t){var m,F,E,T,A,C,v;let{airtableTable:n,fieldMap:e,envEndpoints:r,skuField:s,titleField:a,allowedStatuses:c=j,secretName:w=I}=i;if(!s||!a)throw new Error("quickSync: skuField and titleField are required");let{recordId:g,env:_}=t;if(!g)throw new Error("Automation must pass {recordId}.");if(!_||!r[_]){let R=Object.keys(r).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${R}`)}let b=r[_],h=Math.floor(Date.now()/1e3);y(`Quick-Sync (${n}) start \u2013 epoch ${h}`);let M=await input.secret(w),$=D(M,w),N=base.getTable(n),O=K(e,s,a),l=await N.selectRecordAsync(g,{fields:O});if(!l)throw new Error(`Record ${g} not found in ${n}`);let o=q(l,e);(m=o.sku)!=null||(o.sku=l.getCellValueAsString(s));let d=typeof e[a]=="string"?e[a]:null;d&&((F=o[d])!=null||(o[d]=l.getCellValueAsString(a)||l.name)),o[V]=h;let k=d&&o[d]?o[d]:l.getCellValueAsString(a)||l.name;o.post_status&&!c.includes(o.post_status)&&delete o.post_status;let f={airtableRecordId:l.id,sku:o.sku,wp_id:l.getCellValue("wp_id")||null,fields:o};console.log(JSON.stringify(f,null,2).substring(0,5e3)),output.set("payloadSent",JSON.stringify(f,null,2).slice(0,2500)),y(`POSTing to ${b}`);let{data:u,status:P}=await B(b,$,f),p=(A=(E=u.term_id)!=null?E:u.post_id)!=null?A:(T=u==null?void 0:u.data)==null?void 0:T.post_id,S=(C=u.action)!=null?C:"unknown",x=(v=u.message)!=null?v:"";output.set("syncStatus",u&&p?"Success":`HTTP_${P}`),output.set("action",S),output.set("message",x),output.set("postTitle",k),output.set("wpPostId",p!=null?p:null),y(`\u2705 WP ${S} \u2013  ${k}`)}var J=input.config(),U={title:"post_title",slug:"post_name",website_status:"post_status",excerpt:"post_excerpt",seo_description:"_aioseo_description",release_date:"post_date",sku:"sku",permalink:"custom_permalink_uri",worship_artist:"worship_artist",topics:"topics",category:"global-categories",featured_image_wp_id:{airtableIdField:"featured_image_wp_id",airtableLinkField:"featured_image_link",wpKey:"_thumbnail_id"},chord_sheet_wp_id:{airtableIdField:"chord_sheet_wp_id",wpKey:"chord_sheet_wp_id"},chord_sheet_link:{airtableIdField:"chord_sheet_link",wpKey:"chord_sheet_link"},apple_music_link:"apple_music_link",spotify_link:"spotify_link",youtube_music_link:"youtube_music_link"},H={airtableTable:"Worship",skuField:"sku",titleField:"title",fieldMap:U,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/worship-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/worship-sync"}};L(H,J);})();
