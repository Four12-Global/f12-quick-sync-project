"use strict";(()=>{var S=n=>console.log(`[${new Date().toISOString()}]`,n),V=["publish","draft","trash","private"],L="API-SYNC",x="last_synced";function D(n,t=L){if(!n||!n.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(n).toString("base64")}function Q(n,t,s){let e=new Set;for(let r in n){let i=n[r];typeof i=="string"?e.add(r):(e.add(i.airtableIdField),i.airtableLinkField&&e.add(i.airtableLinkField))}return e.add("wp_id").add(t).add(s),Array.from(e)}function U(n,t){return t==null?null:Array.isArray(t)?t.map(s=>typeof s=="object"&&s!==null&&"name"in s?s.name:String(s)):typeof t=="object"&&t.url?t.url:typeof t=="object"&&t!==null&&"name"in t?t.name:t}function q(n,t){let s=n.parentTable,e={};for(let r in t){let i=t[r];if(typeof i=="string"){let c=n.getCellValue(r);i==="post_status"?e.post_status=c&&c.name?c.name.toLowerCase():typeof c=="string"?c.toLowerCase():null:e[i]=U(r,c);continue}let a=n.getCellValue(i.airtableIdField)||i.airtableLinkField&&n.getCellValue(i.airtableLinkField);a&&(e[i.wpKey]=a)}return e}async function B(n,t,s){let e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${t}`},body:JSON.stringify(s)}),r=await e.text();if(!e.ok)throw new Error(`HTTP ${e.status}: ${r.slice(0,500)}`);return{data:JSON.parse(r),status:e.status}}async function M(n,t){var m,F,T,E,A,C,v;let{airtableTable:s,fieldMap:e,envEndpoints:r,skuField:i,titleField:a,allowedStatuses:c=V,secretName:b=L}=n;if(!i||!a)throw new Error("quickSync: skuField and titleField are required");let{recordId:g,env:f}=t;if(!g)throw new Error("Automation must pass {recordId}.");if(!f||!r[f]){let j=Object.keys(r).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${j}`)}let w=r[f],h=Math.floor(Date.now()/1e3);S(`Quick-Sync (${s}) start \u2013 epoch ${h}`);let $=await input.secret(b),I=D($,b),N=base.getTable(s),O=Q(e,i,a),l=await N.selectRecordAsync(g,{fields:O});if(!l)throw new Error(`Record ${g} not found in ${s}`);let o=q(l,e);(m=o.sku)!=null||(o.sku=l.getCellValueAsString(i));let d=typeof e[a]=="string"?e[a]:null;d&&((F=o[d])!=null||(o[d]=l.getCellValueAsString(a)||l.name)),o[x]=h;let _=d&&o[d]?o[d]:l.getCellValueAsString(a)||l.name;o.post_status&&!c.includes(o.post_status)&&delete o.post_status;let y={airtableRecordId:l.id,sku:o.sku,wp_id:l.getCellValue("wp_id")||null,fields:o};console.log(JSON.stringify(y,null,2).substring(0,5e3)),output.set("payloadSent",JSON.stringify(y,null,2).slice(0,2500)),S(`POSTing to ${w}`);let{data:u,status:P}=await B(w,I,y),p=(A=(T=u.term_id)!=null?T:u.post_id)!=null?A:(E=u==null?void 0:u.data)==null?void 0:E.post_id,k=(C=u.action)!=null?C:"unknown",R=(v=u.message)!=null?v:"";output.set("syncStatus",u&&p?"Success":`HTTP_${P}`),output.set("action",k),output.set("message",R),output.set("postTitle",_),output.set("wpPostId",p!=null?p:null),S(`\u2705 WP ${k} \u2013  ${_}`)}var J=input.config(),H={author_title:"name",author_slug:"slug",author_description:"as_description",profile_image_wp_id:"profile_image",sku:"sku"},W={airtableTable:"author-speaker",skuField:"sku",titleField:"author_title",fieldMap:H,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/author-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/author-sync"}};M(W,J);})();
