"use strict";(()=>{var m=i=>console.log(`[${new Date().toISOString()}]`,i),K=["publish","draft","trash","private"],I="API-SYNC",R="last_synced";function V(i,e=I){if(!i||!i.includes(":"))throw new Error(`Secret "${e}" must be "user:app-password".`);return Buffer.from(i).toString("base64")}function D(i,e,s){let t=new Set;for(let o in i){let n=i[o];typeof n=="string"?t.add(o):(t.add(n.airtableIdField),n.airtableLinkField&&t.add(n.airtableLinkField))}return t.add("wp_id").add(e).add(s),Array.from(t)}function q(i,e){return e==null?null:Array.isArray(e)?e.map(s=>typeof s=="object"&&s!==null&&"name"in s?s.name:String(s)):typeof e=="object"&&e.url?e.url:typeof e=="object"&&e!==null&&"name"in e?e.name:e}function B(i,e){let s=i.parentTable,t={};for(let o in e){let n=e[o];if(typeof n=="string"){let d=i.getCellValue(o);n==="post_status"?t.post_status=d&&d.name?d.name.toLowerCase():typeof d=="string"?d.toLowerCase():null:t[n]=q(o,d);continue}let l=i.getCellValue(n.airtableIdField)||n.airtableLinkField&&i.getCellValue(n.airtableLinkField);l&&(t[n.wpKey]=l)}return t}async function J(i,e,s){let t=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${e}`},body:JSON.stringify(s)}),o=await t.text();if(!t.ok)throw new Error(`HTTP ${t.status}: ${o.slice(0,500)}`);return{data:JSON.parse(o),status:t.status}}async function C(i,e){var S,h,E,T,L,v,A;let{airtableTable:s,fieldMap:t,envEndpoints:o,skuField:n,titleField:l,allowedStatuses:d=K,secretName:b=I}=i;if(!n||!l)throw new Error("quickSync: skuField and titleField are required");let{recordId:_,env:g}=e;if(!_)throw new Error("Automation must pass {recordId}.");if(!g||!o[g]){let j=Object.keys(o).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${j}`)}let k=o[g],y=Math.floor(Date.now()/1e3);m(`Quick-Sync (${s}) start \u2013 epoch ${y}`);let $=await input.secret(b),M=V($,b),N=base.getTable(s),x=D(t,n,l),r=await N.selectRecordAsync(_,{fields:x});if(!r)throw new Error(`Record ${_} not found in ${s}`);let a=B(r,t);(S=a.sku)!=null||(a.sku=r.getCellValueAsString(n));let c=typeof t[l]=="string"?t[l]:null;c&&((h=a[c])!=null||(a[c]=r.getCellValueAsString(l)||r.name)),a[R]=y;let w=c&&a[c]?a[c]:r.getCellValueAsString(l)||r.name;a.post_status&&!d.includes(a.post_status)&&delete a.post_status;let f={airtableRecordId:r.id,sku:a.sku,wp_id:r.getCellValue("wp_id")||null,fields:a};console.log(JSON.stringify(f,null,2).substring(0,5e3)),output.set("payloadSent",JSON.stringify(f,null,2).slice(0,2500)),m(`POSTing to ${k}`);let{data:p,status:O}=await J(k,M,f),u=(L=(E=p.term_id)!=null?E:p.post_id)!=null?L:(T=p==null?void 0:p.data)==null?void 0:T.post_id,F=(v=p.action)!=null?v:"unknown",P=(A=p.message)!=null?A:"";output.set("syncStatus",p&&u?"Success":`HTTP_${O}`),output.set("action",F),output.set("message",P),output.set("postTitle",w),output.set("wpPostId",u!=null?u:null),m(`\u2705 WP ${F} \u2013  ${w}`)}var U={session_title:"post_title",session_slug:"post_name",session_description:"post_content",excerpt:"post_excerpt",session_permalink:"_custom_uri",session_sku:"sku",website_status:"post_status",topics_title:"topics",speaker_title:"author_speaker",series_category:"series-categories",global_categories:"global-categories",featured_image:{airtableIdField:"featured_image_wp_id",airtableLinkField:"featured_image_link",wpKey:"_thumbnail_id"},listing_image:{airtableIdField:"listing_image_wp_id",airtableLinkField:"listing_image_link",wpKey:"listing-image"},no_words_image:{airtableIdField:"no_words_image_wp_id",airtableLinkField:"no_words_image_link",wpKey:"no-words-image"},banner_image:{airtableIdField:"banner_image_wp_id",airtableLinkField:"banner_image_link",wpKey:"banner-image"},pdf_image_1:{airtableIdField:"pdf_image_1_wp_id",airtableLinkField:"pdf_image_1_link",wpKey:"pdf-image-1"},pdf_image_2:{airtableIdField:"pdf_image_2_wp_id",airtableLinkField:"pdf_image_2_link",wpKey:"manual2-image"},pdf_title_1:"custom-pdf-title-1",pdf_link_1:"link_ten",pdf_title_2:"custom-pdf-title-2",pdf_link_2:"link_eleven",alt_link:"link_five",youtube_link:"link_one",vimeo_link:"vimeo_link",spotify_podcast:"spotify-podcast-link",apple_podcast:"apple-podcast-link",publish_timestamp:"last_published"},Q=input.config();C({airtableTable:"Sessions",skuField:"session_sku",titleField:"session_title",fieldMap:U,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/sessions-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/sessions-sync"}},Q);})();
