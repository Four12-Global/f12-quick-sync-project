"use strict";(()=>{var y=i=>console.log(`[${new Date().toISOString()}]`,i),R=["publish","draft","trash","private"],I="API-SYNC",V="last_synced";function K(i,e=I){if(!i||!i.includes(":"))throw new Error(`Secret "${e}" must be "user:app-password".`);return Buffer.from(i).toString("base64")}function D(i,e,n){let t=new Set;for(let r in i){let s=i[r];typeof s=="string"?t.add(r):(t.add(s.airtableIdField),s.airtableLinkField&&t.add(s.airtableLinkField))}return t.add("wp_id").add(e).add(n),Array.from(t)}function q(i,e){return e==null?null:Array.isArray(e)?e.map(n=>typeof n=="object"&&n!==null&&"name"in n?n.name:String(n)):typeof e=="object"&&e.url?e.url:typeof e=="object"&&e!==null&&"name"in e?e.name:e}function B(i,e){let n=i.parentTable,t={};for(let r in e){let s=e[r];if(typeof s=="string"){let c=i.getCellValue(r);s==="post_status"?t.post_status=c&&c.name?c.name.toLowerCase():typeof c=="string"?c.toLowerCase():null:t[s]=q(r,c);continue}let o=i.getCellValue(s.airtableIdField)||s.airtableLinkField&&i.getCellValue(s.airtableLinkField);o&&(t[s.wpKey]=o)}return t}async function J(i,e,n){let t=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${e}`},body:JSON.stringify(n)}),r=await t.text();if(!t.ok)throw new Error(`HTTP ${t.status}: ${r.slice(0,500)}`);return{data:JSON.parse(r),status:t.status}}async function C(i,e){var F,h,E,T,L,v,A;let{airtableTable:n,fieldMap:t,envEndpoints:r,skuField:s,titleField:o,allowedStatuses:c=R,secretName:m=I}=i;if(!s||!o)throw new Error("quickSync: skuField and titleField are required");let{recordId:_,env:g}=e;if(!_)throw new Error("Automation must pass {recordId}.");if(!g||!r[g]){let j=Object.keys(r).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${j}`)}let b=r[g],k=Math.floor(Date.now()/1e3);y(`Quick-Sync (${n}) start \u2013 epoch ${k}`);let $=await input.secret(m),M=K($,m),N=base.getTable(n),x=D(t,s,o),l=await N.selectRecordAsync(_,{fields:x});if(!l)throw new Error(`Record ${_} not found in ${n}`);let a=B(l,t);(F=a.sku)!=null||(a.sku=l.getCellValueAsString(s));let d=typeof t[o]=="string"?t[o]:null;d&&((h=a[d])!=null||(a[d]=l.getCellValueAsString(o)||l.name)),a[V]=k;let w=d&&a[d]?a[d]:l.getCellValueAsString(o)||l.name;a.post_status&&!c.includes(a.post_status)&&delete a.post_status;let f={airtableRecordId:l.id,sku:a.sku,wp_id:l.getCellValue("wp_id")||null,fields:a};console.log(JSON.stringify(f,null,2).substring(0,5e3)),output.set("payloadSent",JSON.stringify(f,null,2).slice(0,2500)),y(`POSTing to ${b}`);let{data:p,status:O}=await J(b,M,f),u=(L=(E=p.term_id)!=null?E:p.post_id)!=null?L:(T=p==null?void 0:p.data)==null?void 0:T.post_id,S=(v=p.action)!=null?v:"unknown",P=(A=p.message)!=null?A:"";output.set("syncStatus",p&&u?"Success":`HTTP_${O}`),output.set("action",S),output.set("message",P),output.set("postTitle",w),output.set("wpPostId",u!=null?u:null),y(`\u2705 WP ${S} \u2013  ${w}`)}var U={series_title:"post_title",series_slug:"post_name",long_date:"post_date",website_status:"post_status",series_sku:"sku",excerpt:"post_excerpt",series_permalink:"custom_permalink_uri",global_categories:"global-categories",series_filter_category:"series-categories",topics:"topics",series_template:"series-templates",featured_image:{airtableIdField:"featured_image_wp_id",airtableLinkField:"featured_image_link",wpKey:"_thumbnail_id"},listing_image:{airtableIdField:"listing_image_wp_id",airtableLinkField:"listing_image_link",wpKey:"listing-image"},no_words_image:{airtableIdField:"no_words_image_wp_id",airtableLinkField:"no_words_image_link",wpKey:"no-words-image"},banner_image:{airtableIdField:"banner_image_wp_id",airtableLinkField:"banner_image_link",wpKey:"banner-image"},primary_cta_image:{airtableIdField:"primary_cta_image_wp_id",airtableLinkField:"primary_cta_image_link",wpKey:"manual1-image"},series_description_title:"series-description_title",series_description:"series-description",who_is_it_for:"series-who-is-it-for",series_purpose:"series-purpose",series_colour_1:"series-colour-1",series_colour_2:"series-colour-2",print_pdf_link:"link_five",custom_pdf_link:"link_ten",youtube_playlist:"youtube-playlist-link",spotify_playlist:"spotify-playlist-link",apple_playlist:"apple-playlist-link",highlights_video:"highlights-video",primary_cta_heading:"manual1-title",primary_cta_title:"manual1-link-title",primary_cta_link:"manual1-link",secondary_cta_heading:"manual2-title",secondary_cta_title:"manual2-link-title",secondary_cta_link:"manual2-link",seo_description:"_aioseo_description",session_title:"custom-session-title",sessions_list:"series-episode-list",session_list_1:"series-episode-list-more",session_list_2:"series-episode-list-3",session_list_3:"series-episode-list-4"},Q=input.config();C({airtableTable:"Series",skuField:"series_sku",titleField:"series_title",fieldMap:U,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/series-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/series-sync"}},Q);})();
