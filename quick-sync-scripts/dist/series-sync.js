"use strict";(()=>{var g=t=>console.log(`[${new Date().toISOString()}]`,t),N=["publish","draft","trash","private"],T="API-SYNC",x="last_synced";function K(t,e=T){if(!t||!t.includes(":"))throw new Error(`Secret "${e}" must be "user:app-password".`);return Buffer.from(t).toString("base64")}function O(t,e,a){let i=new Set;for(let r in t){let s=t[r];typeof s=="string"?i.add(r):(i.add(s.airtableIdField),s.airtableLinkField&&i.add(s.airtableLinkField))}return i.add("wp_id").add(e).add(a),Array.from(i)}function P(t,e){return e==null?null:Array.isArray(e)?e.map(a=>typeof a=="object"&&a!==null&&"name"in a?a.name:String(a)):typeof e=="object"&&e.url?e.url:typeof e=="object"&&e!==null&&"name"in e?e.name:e}function R(t,e){let a=t.parentTable,i={};for(let r in e){let s=e[r];if(typeof s=="string"){let o=t.getCellValue(r);s==="post_status"?i.post_status=o&&o.name?o.name.toLowerCase():typeof o=="string"?o.toLowerCase():null:i[s]=P(r,o);continue}let d=t.getCellValue(s.airtableIdField)||s.airtableLinkField&&t.getCellValue(s.airtableLinkField);d&&(i[s.wpKey]=d)}return i}async function D(t,e,a){let i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${e}`},body:JSON.stringify(a)}),r=await i.text();if(!i.ok)throw new Error(`HTTP ${i.status}: ${r.slice(0,500)}`);return{data:JSON.parse(r),status:i.status}}async function E(t){var b,k,w,S,F,h;let{airtableTable:e,fieldMap:a,envEndpoints:i,skuField:r,titleField:s,allowedStatuses:d=N,secretName:o=T}=t;if(!r||!s)throw new Error("quickSync: skuField and titleField are required");let{recordId:c,env:L="prod"}=input.config();if(!c)throw new Error("Automation must pass {recordId}.");let u=i[L]||i.prod;if(!u)throw new Error("wpUrl must be provided in config.");let f=Math.floor(Date.now()/1e3);g(`Quick-Sync (${e}) start \u2013 epoch ${f}`);let A=await input.secret(o),I=K(A,o),C=base.getTable(e),v=O(a,r,s),l=await C.selectRecordAsync(c,{fields:v});if(!l)throw new Error(`Record ${c} not found in ${e}`);let n=R(l,a);(b=n.sku)!=null||(n.sku=l.getCellValueAsString(r)),(k=n.post_title)!=null||(n.post_title=l.getCellValueAsString(s)||l.name),n[x]=f,n.post_status&&!d.includes(n.post_status)&&delete n.post_status;let _={airtableRecordId:l.id,sku:n.sku,wp_id:l.getCellValue("wp_id")||null,fields:n};console.log(JSON.stringify(_,null,2).substring(0,5e3)),output.set("payloadSent",JSON.stringify(_,null,2).slice(0,2500)),g(`POSTing to ${u}`);let{data:p,status:$}=await D(u,I,_),y=(S=p.post_id)!=null?S:(w=p==null?void 0:p.data)==null?void 0:w.post_id,m=(F=p.action)!=null?F:"unknown",M=(h=p.message)!=null?h:"";output.set("syncStatus",p&&y?"Success":`HTTP_${$}`),output.set("action",m),output.set("message",M),output.set("postTitle",n.post_title),output.set("wpPostId",y),g(`\u2705 WP ${m} \u2013  ${n.post_title}`)}var V={series_title:"post_title",series_slug:"post_name",long_date:"post_date",website_status:"post_status",series_sku:"sku",excerpt:"post_excerpt",series_permalink:"custom_permalink_uri",global_categories:"global-categories",series_filter_category:"series-categories",topics:"topics",series_template:"series-templates",featured_image:{airtableIdField:"featured_image_wp_id",airtableLinkField:"featured_image_link",wpKey:"_thumbnail_id"},listing_image:{airtableIdField:"listing_image_wp_id",airtableLinkField:"listing_image_link",wpKey:"listing-image"},no_words_image:{airtableIdField:"no_words_image_wp_id",airtableLinkField:"no_words_image_link",wpKey:"no-words-image"},banner_image:{airtableIdField:"banner_image_wp_id",airtableLinkField:"banner_image_link",wpKey:"banner-image"},primary_cta_image:{airtableIdField:"primary_cta_image_wp_id",airtableLinkField:"primary_cta_image_link",wpKey:"manual1-image"},series_description_title:"series-description_title",series_description:"series-description",who_is_it_for:"series-who-is-it-for",series_purpose:"series-purpose",series_colour_1:"series-colour-1",series_colour_2:"series-colour-2",print_pdf_link:"link_five",custom_pdf_link:"link_ten",youtube_playlist:"youtube-playlist-link",spotify_playlist:"spotify-playlist-link",apple_playlist:"apple-playlist-link",highlights_video:"highlights-video",primary_cta_heading:"manual1-title",primary_cta_title:"manual1-link-title",primary_cta_link:"manual1-link",secondary_cta_heading:"manual2-title",secondary_cta_title:"manual2-link-title",secondary_cta_link:"manual2-link",seo_description:"_aioseo_description",session_title:"custom-session-title",sessions_list:"series-episode-list",session_list_1:"series-episode-list-more",session_list_2:"series-episode-list-3",session_list_3:"series-episode-list-4"};E({airtableTable:"Series",skuField:"series_sku",titleField:"series_title",fieldMap:V,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/series-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/series-sync"}});})();
