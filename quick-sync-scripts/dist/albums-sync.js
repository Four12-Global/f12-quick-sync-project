"use strict";(()=>{var y=n=>console.log(`[${new Date().toISOString()}]`,n),V=["publish","draft","trash","private"],L="API-SYNC",x="last_synced";function D(n,t=L){if(!n||!n.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(n).toString("base64")}function B(n,t,s){let e=new Set;for(let a in n){let i=n[a];typeof i=="string"?e.add(a):(e.add(i.airtableIdField),i.airtableLinkField&&e.add(i.airtableLinkField))}return e.add("wp_id").add(t).add(s),Array.from(e)}function U(n,t){return t==null?null:Array.isArray(t)?t.map(s=>typeof s=="object"&&s!==null&&"name"in s?s.name:String(s)):typeof t=="object"&&t.url?t.url:typeof t=="object"&&t!==null&&"name"in t?t.name:t}function q(n,t){let s=n.parentTable,e={};for(let a in t){let i=t[a];if(typeof i=="string"){let u=n.getCellValue(a);i==="post_status"?e.post_status=u&&u.name?u.name.toLowerCase():typeof u=="string"?u.toLowerCase():null:e[i]=U(a,u);continue}let r=n.getCellValue(i.airtableIdField)||i.airtableLinkField&&n.getCellValue(i.airtableLinkField);r&&(e[i.wpKey]=r)}return e}async function J(n,t,s){let e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Basic ${t}`},body:JSON.stringify(s)}),a=await e.text();if(!e.ok)throw new Error(`HTTP ${e.status}: ${a.slice(0,500)}`);return{data:JSON.parse(a),status:e.status}}async function M(n,t){var h,F,E,T,A,C,v;let{airtableTable:s,fieldMap:e,envEndpoints:a,skuField:i,titleField:r,allowedStatuses:u=V,secretName:b=L}=n;if(!i||!r)throw new Error("quickSync: skuField and titleField are required");let{recordId:g,env:f}=t;if(!g)throw new Error("Automation must pass {recordId}.");if(!f||!a[f]){let R=Object.keys(a).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${R}`)}let w=a[f],S=Math.floor(Date.now()/1e3);y(`Quick-Sync (${s}) start \u2013 epoch ${S}`);let $=await input.secret(b),I=D($,b),N=base.getTable(s),O=B(e,i,r),l=await N.selectRecordAsync(g,{fields:O});if(!l)throw new Error(`Record ${g} not found in ${s}`);let o=q(l,e);(h=o.sku)!=null||(o.sku=l.getCellValueAsString(i));let d=typeof e[r]=="string"?e[r]:null;d&&((F=o[d])!=null||(o[d]=l.getCellValueAsString(r)||l.name)),o[x]=S;let m=d&&o[d]?o[d]:l.getCellValueAsString(r)||l.name;o.post_status&&!u.includes(o.post_status)&&delete o.post_status;let _={airtableRecordId:l.id,sku:o.sku,wp_id:l.getCellValue("wp_id")||null,fields:o};console.log(JSON.stringify(_,null,2).substring(0,5e3)),output.set("payloadSent",JSON.stringify(_,null,2).slice(0,2500)),y(`POSTing to ${w}`);let{data:c,status:P}=await J(w,I,_),p=(A=(E=c.term_id)!=null?E:c.post_id)!=null?A:(T=c==null?void 0:c.data)==null?void 0:T.post_id,k=(C=c.action)!=null?C:"unknown",j=(v=c.message)!=null?v:"";output.set("syncStatus",c&&p?"Success":`HTTP_${P}`),output.set("action",k),output.set("message",j),output.set("postTitle",m),output.set("wpPostId",p!=null?p:null),y(`\u2705 WP ${k} \u2013  ${m}`)}var K=input.config(),Q={title:"post_title",slug:"post_name",website_status:"post_status",sku:"sku",worship_artist:"worship_artist",featured_image_wp_id:{airtableIdField:"featured_image_wp_id",wpKey:"_thumbnail_id"},chord_sheet_wp_id:{airtableIdField:"chord_sheet_wp_id",wpKey:"chord_sheet_link"},apple_music_link:"apple_music_link",spotify_link:"spotify_link",youtube_music_link:"youtube_music_link"},W={airtableTable:"Albums",skuField:"sku",titleField:"title",fieldMap:Q,envEndpoints:{prod:"https://four12global.com/wp-json/four12/v1/albums-sync",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/four12/v1/albums-sync"}};M(W,K);})();
