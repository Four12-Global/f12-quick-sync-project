"use strict";(()=>{var x="API-SYNC";function U(e,i=x){if(!e||!e.includes(":"))throw new Error(`Secret "${i}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}var c=e=>console.log(`[${new Date().toISOString()}]`,e);async function P(e){let i=new Map;if(e.fields&&Array.isArray(e.fields))for(let d of e.fields)d.id&&d.name&&i.set(d.id,d.name);return i}var R="API-SYNC";async function A(e){var d,u;let i=await fetch(e.url);if(!i.ok)throw new Error(`\u2198 download ${e.url} \u2192 HTTP ${i.status}`);return{blob:await i.blob(),filename:(d=e.filename)!=null?d:"file",contentType:(u=i.headers.get("content-type"))!=null?u:"application/octet-stream",srcUrl:e.url}}async function v(e,i,{blob:d,filename:u,contentType:m},p){c(`Uploading ${u}${p?` for record ${p}`:""} \u2026`);try{let n=await fetch(e,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":m,"Content-Disposition":`attachment; filename="${u}"`},body:d}),l=await n.json();if(!n.ok||!(l!=null&&l.id))throw new Error(`\u2197 WP upload failed ${n.status}: ${JSON.stringify(l).slice(0,200)}`);return c(`\u2705 Uploaded ${u} \u2192 ${l.source_url} (wpId: ${l.id})`),{id:String(l.id),url:l.source_url}}catch(n){throw console.error(`\u274C Upload failed ${u}${p?` for record ${p}`:""}: ${n.message}`),n}}async function V(e,i,d,u,m,p){var T,F,I,C,w,_,$;let n=(T=e.getCellValue(i.attachmentField))!=null?T:[],l=(F=e.getCellValue(i.wpIdField))!=null?F:"",b=(I=e.getCellValue(i.wpUrlField))!=null?I:"",h=(C=e.getCellValue(i.airtableCacheField))!=null?C:"",f=(h!=null?h:"").split(",").filter(Boolean),S=i.externalUrlField?(((w=e.getCellValueAsString)==null?void 0:w.call(e,i.externalUrlField))||"").trim():"";if(n.length===0&&S)return{wpIds:null,wpUrls:S,cacheUrls:null,changed:S!==b};if(n.length===0)return l||b||h?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!i.isMultiple){let a=n[0];if(f.includes(a.id)&&l)return c(`\u21A9\uFE0F Reusing ${(_=a.filename)!=null?_:"file"} (wpId: ${l})`),{changed:!1};try{let{blob:o,filename:g,contentType:y}=await A(a),{id:s,url:t}=await v(d,u,{blob:o,filename:g,contentType:y},m);return{wpIds:s,wpUrls:t,cacheUrls:a.id,changed:!0}}catch(o){return p&&p(o),c(`\u26A0\uFE0F  single-upload failed ${a.url}: ${o.message}`),{changed:!1}}}if(i.isMultiple){let a=[];for(let o of n){if(f.includes(o.id)){c(`\u21A9\uFE0F Reusing ${($=o.filename)!=null?$:"file"}\u2026`);continue}try{let{blob:g,filename:y,contentType:s}=await A(o),{id:t,url:r}=await v(d,u,{blob:g,filename:y,contentType:s},m);a.push({id:t,url:r,airtableId:o.id})}catch(g){p&&p(g),c(`\u274C  multi\u2011upload failed ${o.url}: ${g.message}`)}}if(a.length||n.some(o=>f.includes(o.id))){let o=n.filter(s=>f.includes(s.id)).map(s=>s.id),g=l.split(",").filter(Boolean).filter((s,t)=>{var r;return f.includes((r=n[t])==null?void 0:r.id)}),y=b.split(",").filter(Boolean).filter((s,t)=>{var r;return f.includes((r=n[t])==null?void 0:r.id)});return{wpIds:[...g,...a.map(s=>s.id)].join(","),wpUrls:[...y,...a.map(s=>s.url)].join(","),cacheUrls:[...o,...a.map(s=>s.airtableId)].join(","),changed:!0}}return{changed:!1}}return{changed:!1}}async function N(e,i){var g,y,s;let d=!1,{airtableTable:u,envMediaEndpoints:m,imageFields:p,lastModifiedField:n,publishTimestampField:l,secretName:b=R}=e,{recordId:h,env:f}=i;if(!h)throw new Error("Automation must pass {recordId}.");if(!f||!m[f]){let t=Object.keys(m).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${t}`)}let S=m[f],T=U(await input.secret(b),b),F=base.getTable(u),I=await P(F),C=[n,l,...p.flatMap(t=>[t.attachmentField,t.wpIdField,t.wpUrlField,t.airtableCacheField])],w=await F.selectRecordAsync(h,{fields:C});if(!w)throw new Error(`Record ${h} not found.`);let _=w.getCellValue(n),$=w.getCellValue(l);if(_&&$&&Date.parse(_)<=Date.parse($)){c("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let a={},o=!1;for(let t of p)try{let r=await V(w,t,S,T,h,E=>{d=!0});r&&r.changed&&(a[t.wpIdField]=(g=r.wpIds)!=null?g:null,a[t.wpUrlField]=(y=r.wpUrls)!=null?y:null,a[t.airtableCacheField]=(s=r.cacheUrls)!=null?s:null,o=!0)}catch(r){d=!0,c(`\u26A0\uFE0F  Error processing field spec "${t.attachmentField}": ${r.message}`)}if(o){d?c("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):a[l]=new Date().toISOString();try{await F.updateRecordAsync(w,a),c("\u2705\xA0Media sync complete & fields updated")}catch(t){let r=t.message,E=r.match(/Field "(.+?)"/);if(E&&E[1]){let M=E[1],k=`Error updating Airtable: The field "${I.get(M)||"Unknown Field"}" (ID: ${M}) could not accept the value provided by the script. Please verify its field type.`;throw c(`\u274C ${k}`),new Error(k)}throw c(`\u274C An unexpected error occurred while updating Airtable: ${r}`),t}}else c("\u2714\xA0No media changes detected \u2013 nothing to write")}var L=input.config(),O={airtableTable:"Worship",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"featured_image_attachment",wpIdField:"featured_image_wp_id",wpUrlField:"featured_image_link",airtableCacheField:"featured_image_external",isMultiple:!1},{attachmentField:"chord_sheet_attachment",wpIdField:"chord_sheet_wp_id",wpUrlField:"chord_sheet_link",airtableCacheField:"chord_sheet_external",isMultiple:!1}]};N(O,L);})();
