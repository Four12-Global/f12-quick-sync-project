"use strict";(()=>{var x="API-SYNC";function A(e,i=x){if(!e||!e.includes(":"))throw new Error(`Secret "${i}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}var c=e=>console.log(`[${new Date().toISOString()}]`,e);async function P(e){let i=new Map;if(e.fields&&Array.isArray(e.fields))for(let d of e.fields)d.id&&d.name&&i.set(d.id,d.name);return i}var R="API-SYNC";async function U(e){var d,u;let i=await fetch(e.url);if(!i.ok)throw new Error(`\u2198 download ${e.url} \u2192 HTTP ${i.status}`);return{blob:await i.blob(),filename:(d=e.filename)!=null?d:"file",contentType:(u=i.headers.get("content-type"))!=null?u:"application/octet-stream",srcUrl:e.url}}async function v(e,i,{blob:d,filename:u,contentType:w},p){c(`Uploading ${u}${p?` for record ${p}`:""} \u2026`);try{let n=await fetch(e,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":w,"Content-Disposition":`attachment; filename="${u}"`},body:d}),l=await n.json();if(!n.ok||!(l!=null&&l.id))throw new Error(`\u2197 WP upload failed ${n.status}: ${JSON.stringify(l).slice(0,200)}`);return c(`\u2705 Uploaded ${u} \u2192 ${l.source_url} (wpId: ${l.id})`),{id:String(l.id),url:l.source_url}}catch(n){throw console.error(`\u274C Upload failed ${u}${p?` for record ${p}`:""}: ${n.message}`),n}}async function V(e,i,d,u,w,p){var E,F,I,C,h,$,T;let n=(E=e.getCellValue(i.attachmentField))!=null?E:[],l=(F=e.getCellValue(i.wpIdField))!=null?F:"",b=(I=e.getCellValue(i.wpUrlField))!=null?I:"",m=(C=e.getCellValue(i.airtableCacheField))!=null?C:"",f=(m!=null?m:"").split(",").filter(Boolean),S=i.externalUrlField?(((h=e.getCellValueAsString)==null?void 0:h.call(e,i.externalUrlField))||"").trim():"";if(n.length===0&&S)return{wpIds:null,wpUrls:S,cacheUrls:null,changed:S!==b};if(n.length===0)return l||b||m?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!i.isMultiple){let s=n[0];if(f.includes(s.id)&&l)return c(`\u21A9\uFE0F Reusing ${($=s.filename)!=null?$:"file"} (wpId: ${l})`),{changed:!1};try{let{blob:o,filename:g,contentType:y}=await U(s),{id:a,url:t}=await v(d,u,{blob:o,filename:g,contentType:y},w);return{wpIds:a,wpUrls:t,cacheUrls:s.id,changed:!0}}catch(o){return p&&p(o),c(`\u26A0\uFE0F  single-upload failed ${s.url}: ${o.message}`),{changed:!1}}}if(i.isMultiple){let s=[];for(let o of n){if(f.includes(o.id)){c(`\u21A9\uFE0F Reusing ${(T=o.filename)!=null?T:"file"}\u2026`);continue}try{let{blob:g,filename:y,contentType:a}=await U(o),{id:t,url:r}=await v(d,u,{blob:g,filename:y,contentType:a},w);s.push({id:t,url:r,airtableId:o.id})}catch(g){p&&p(g),c(`\u274C  multi\u2011upload failed ${o.url}: ${g.message}`)}}if(s.length||n.some(o=>f.includes(o.id))){let o=n.filter(a=>f.includes(a.id)).map(a=>a.id),g=l.split(",").filter(Boolean).filter((a,t)=>{var r;return f.includes((r=n[t])==null?void 0:r.id)}),y=b.split(",").filter(Boolean).filter((a,t)=>{var r;return f.includes((r=n[t])==null?void 0:r.id)});return{wpIds:[...g,...s.map(a=>a.id)].join(","),wpUrls:[...y,...s.map(a=>a.url)].join(","),cacheUrls:[...o,...s.map(a=>a.airtableId)].join(","),changed:!0}}return{changed:!1}}return{changed:!1}}async function N(e,i){var g,y,a;let d=!1,{airtableTable:u,envMediaEndpoints:w,imageFields:p,lastModifiedField:n,publishTimestampField:l,secretName:b=R}=e,{recordId:m,env:f}=i;if(!m)throw new Error("Automation must pass {recordId}.");if(!f||!w[f]){let t=Object.keys(w).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${t}`)}let S=w[f],E=A(await input.secret(b),b),F=base.getTable(u),I=await P(F),C=[n,l,...p.flatMap(t=>[t.attachmentField,t.wpIdField,t.wpUrlField,t.airtableCacheField])],h=await F.selectRecordAsync(m,{fields:C});if(!h)throw new Error(`Record ${m} not found.`);let $=h.getCellValue(n),T=h.getCellValue(l);if($&&T&&Date.parse($)<=Date.parse(T)){c("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let s={},o=!1;for(let t of p)try{let r=await V(h,t,S,E,m,_=>{d=!0});r&&r.changed&&(s[t.wpIdField]=(g=r.wpIds)!=null?g:null,s[t.wpUrlField]=(y=r.wpUrls)!=null?y:null,s[t.airtableCacheField]=(a=r.cacheUrls)!=null?a:null,o=!0)}catch(r){d=!0,c(`\u26A0\uFE0F  Error processing field spec "${t.attachmentField}": ${r.message}`)}if(o){d?c("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):s[l]=new Date().toISOString();try{await F.updateRecordAsync(h,s),c("\u2705\xA0Media sync complete & fields updated")}catch(t){let r=t.message,_=r.match(/Field "(.+?)"/);if(_&&_[1]){let M=_[1],k=`Error updating Airtable: The field "${I.get(M)||"Unknown Field"}" (ID: ${M}) could not accept the value provided by the script. Please verify its field type.`;throw c(`\u274C ${k}`),new Error(k)}throw c(`\u274C An unexpected error occurred while updating Airtable: ${r}`),t}}else c("\u2714\xA0No media changes detected \u2013 nothing to write")}var L={airtableTable:"author-speaker",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"profile_image_attachment",wpIdField:"profile_image_wp_id",wpUrlField:"profile_image_link",airtableCacheField:"profile_image_external",isMultiple:!1}]},O=input.config();N(L,O);})();
