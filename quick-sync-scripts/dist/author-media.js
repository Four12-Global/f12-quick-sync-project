"use strict";(()=>{var M="API-SYNC";function I(e,t=M){if(!e||!e.includes(":"))throw new Error(`Secret "${t}" must be "user:app-password".`);return Buffer.from(e).toString("base64")}var f=e=>console.log(`[${new Date().toISOString()}]`,e),U="API-SYNC";async function k(e){var o,d;let t=await fetch(e.url);if(!t.ok)throw new Error(`\u2198 download ${e.url} \u2192 HTTP ${t.status}`);return{blob:await t.blob(),filename:(o=e.filename)!=null?o:"file",contentType:(d=t.headers.get("content-type"))!=null?d:"application/octet-stream",srcUrl:e.url}}async function $(e,t,{blob:o,filename:d,contentType:c}){let a=await fetch(e,{method:"POST",headers:{Authorization:`Basic ${t}`,"Content-Type":c,"Content-Disposition":`attachment; filename="${d}"`},body:o}),s=await a.json();if(!a.ok||!(s!=null&&s.id))throw new Error(`\u2197 WP upload failed ${a.status}: ${JSON.stringify(s).slice(0,200)}`);return{id:String(s.id),url:s.source_url}}async function A(e,t,o,d,c){var w,C,T,S,E;let a=(w=e.getCellValue(t.attachmentField))!=null?w:[],s=(C=e.getCellValue(t.wpIdField))!=null?C:"",m=(T=e.getCellValue(t.wpUrlField))!=null?T:"",F=(S=e.getCellValue(t.airtableCacheField))!=null?S:"",p=t.externalUrlField?(((E=e.getCellValueAsString)==null?void 0:E.call(e,t.externalUrlField))||"").trim():"";if(a.length===0&&p)return{wpIds:null,wpUrls:p,cacheUrls:null,changed:p!==m};if(a.length===0)return s||m||F?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!t.isMultiple){let n=a[0],i=n.url;if(i===F&&s)return{changed:!1};try{let{blob:l,filename:u,contentType:h}=await k(n),{id:y,url:b}=await $(o,d,{blob:l,filename:u,contentType:h});return{wpIds:y,wpUrls:b,cacheUrls:i,changed:!0}}catch(l){return c&&c(l),f(`\u26A0\uFE0F  single-upload failed ${n.url}: ${l.message}`),{changed:!1}}}if(t.isMultiple){let n=[];for(let i of a)try{let{blob:l,filename:u,contentType:h}=await k(i),{id:y,url:b}=await $(o,d,{blob:l,filename:u,contentType:h});n.push({id:y,url:b})}catch(l){c&&c(l),f(`\u274C  multi\u2011upload failed ${i.url}: ${l.message}`)}return n.length?{wpIds:n.map(i=>i.id).join(","),wpUrls:n.map(i=>i.url).join(","),cacheUrls:a.map(i=>i.url).join(","),changed:!0}:{changed:!1}}return{changed:!1}}async function v(e,t){var y,b,_;let o=!1,{airtableTable:d,envMediaEndpoints:c,imageFields:a,lastModifiedField:s,publishTimestampField:m,secretName:F=U}=e,{recordId:p,env:w}=t;if(!p)throw new Error("Automation must pass {recordId}.");if(!w||!c[w]){let r=Object.keys(c).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${r}`)}let C=c[w],T=I(await input.secret(F),F),S=base.getTable(d),E=[s,m,...a.flatMap(r=>[r.attachmentField,r.wpIdField,r.wpUrlField,r.airtableCacheField])],n=await S.selectRecordAsync(p,{fields:E});if(!n)throw new Error(`Record ${p} not found.`);let i=n.getCellValue(s),l=n.getCellValue(m);if(i&&l&&Date.parse(i)<=Date.parse(l)){f("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let u={},h=!1;for(let r of a)try{let g=await A(n,r,C,T,V=>{o=!0});g&&g.changed&&(u[r.wpIdField]=(y=g.wpIds)!=null?y:null,u[r.wpUrlField]=(b=g.wpUrls)!=null?b:null,u[r.airtableCacheField]=(_=g.cacheUrls)!=null?_:null,h=!0)}catch(g){o=!0,f(`\u26A0\uFE0F  ${r.attachmentField}: ${g.message}`)}h?(o?f("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):u[m]=new Date().toISOString(),await S.updateRecordAsync(n,u),f("\u2705\xA0Media sync complete & fields updated")):f("\u2714\xA0No media changes detected \u2013 nothing to write")}var x={airtableTable:"author-speaker",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com//wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"profile_image_attachment",wpIdField:"profile_image_wp_id",wpUrlField:"profile_image_link",airtableCacheField:"profile_image_external",isMultiple:!1}]},N=input.config();v(x,N);})();
