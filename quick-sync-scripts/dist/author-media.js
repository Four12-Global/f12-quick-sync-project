"use strict";(()=>{var v="API-SYNC";function I(t,i=v){if(!t||!t.includes(":"))throw new Error(`Secret "${i}" must be "user:app-password".`);return Buffer.from(t).toString("base64")}var p=t=>console.log(`[${new Date().toISOString()}]`,t),A="API-SYNC";async function k(t){var c,o;let i=await fetch(t.url);if(!i.ok)throw new Error(`\u2198 download ${t.url} \u2192 HTTP ${i.status}`);return{blob:await i.blob(),filename:(c=t.filename)!=null?c:"file",contentType:(o=i.headers.get("content-type"))!=null?o:"application/octet-stream",srcUrl:t.url}}async function U(t,i,{blob:c,filename:o,contentType:m},d){p(`Uploading ${o}${d?` for record ${d}`:""} \u2026`);try{let n=await fetch(t,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":m,"Content-Disposition":`attachment; filename="${o}"`},body:c}),s=await n.json();if(!n.ok||!(s!=null&&s.id))throw new Error(`\u2197 WP upload failed ${n.status}: ${JSON.stringify(s).slice(0,200)}`);return p(`\u2705 Uploaded ${o} \u2192 ${s.source_url} (wpId: ${s.id})`),{id:String(s.id),url:s.source_url}}catch(n){throw console.error(`\u274C Upload failed ${o}${d?` for record ${d}`:""}: ${n.message}`),n}}async function x(t,i,c,o,m,d){var _,$,E,w,C,T,h;let n=(_=t.getCellValue(i.attachmentField))!=null?_:[],s=($=t.getCellValue(i.wpIdField))!=null?$:"",F=(E=t.getCellValue(i.wpUrlField))!=null?E:"",f=(w=t.getCellValue(i.airtableCacheField))!=null?w:"",g=(f!=null?f:"").split(",").filter(Boolean),S=i.externalUrlField?(((C=t.getCellValueAsString)==null?void 0:C.call(t,i.externalUrlField))||"").trim():"";if(n.length===0&&S)return{wpIds:null,wpUrls:S,cacheUrls:null,changed:S!==F};if(n.length===0)return s||F||f?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!i.isMultiple){let l=n[0];if(g.includes(l.id)&&s)return p(`\u21A9\uFE0F Reusing ${(T=l.filename)!=null?T:"file"} (wpId: ${s})`),{changed:!1};try{let{blob:a,filename:u,contentType:y}=await k(l),{id:e,url:r}=await U(c,o,{blob:a,filename:u,contentType:y},m);return{wpIds:e,wpUrls:r,cacheUrls:l.id,changed:!0}}catch(a){return d&&d(a),p(`\u26A0\uFE0F  single-upload failed ${l.url}: ${a.message}`),{changed:!1}}}if(i.isMultiple){let l=[];for(let a of n){if(g.includes(a.id)){p(`\u21A9\uFE0F Reusing ${(h=a.filename)!=null?h:"file"}\u2026`);continue}try{let{blob:u,filename:y,contentType:e}=await k(a),{id:r,url:b}=await U(c,o,{blob:u,filename:y,contentType:e},m);l.push({id:r,url:b,airtableId:a.id})}catch(u){d&&d(u),p(`\u274C  multi\u2011upload failed ${a.url}: ${u.message}`)}}if(l.length||n.some(a=>g.includes(a.id))){let a=n.filter(e=>g.includes(e.id)).map(e=>e.id),u=s.split(",").filter(Boolean).filter((e,r)=>{var b;return g.includes((b=n[r])==null?void 0:b.id)}),y=F.split(",").filter(Boolean).filter((e,r)=>{var b;return g.includes((b=n[r])==null?void 0:b.id)});return{wpIds:[...u,...l.map(e=>e.id)].join(","),wpUrls:[...y,...l.map(e=>e.url)].join(","),cacheUrls:[...a,...l.map(e=>e.airtableId)].join(","),changed:!0}}return{changed:!1}}return{changed:!1}}async function M(t,i){var a,u,y;let c=!1,{airtableTable:o,envMediaEndpoints:m,imageFields:d,lastModifiedField:n,publishTimestampField:s,secretName:F=A}=t,{recordId:f,env:g}=i;if(!f)throw new Error("Automation must pass {recordId}.");if(!g||!m[g]){let e=Object.keys(m).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${e}`)}let S=m[g],_=I(await input.secret(F),F),$=base.getTable(o),E=[n,s,...d.flatMap(e=>[e.attachmentField,e.wpIdField,e.wpUrlField,e.airtableCacheField])],w=await $.selectRecordAsync(f,{fields:E});if(!w)throw new Error(`Record ${f} not found.`);let C=w.getCellValue(n),T=w.getCellValue(s);if(C&&T&&Date.parse(C)<=Date.parse(T)){p("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let h={},l=!1;for(let e of d)try{let r=await x(w,e,S,_,f,b=>{c=!0});r&&r.changed&&(h[e.wpIdField]=(a=r.wpIds)!=null?a:null,h[e.wpUrlField]=(u=r.wpUrls)!=null?u:null,h[e.airtableCacheField]=(y=r.cacheUrls)!=null?y:null,l=!0)}catch(r){c=!0,p(`\u26A0\uFE0F  ${e.attachmentField}: ${r.message}`)}l?(c?p("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):h[s]=new Date().toISOString(),await $.updateRecordAsync(w,h),p("\u2705\xA0Media sync complete & fields updated")):p("\u2714\xA0No media changes detected \u2013 nothing to write")}var N={airtableTable:"author-speaker",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com//wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"profile_image_attachment",wpIdField:"profile_image_wp_id",wpUrlField:"profile_image_link",airtableCacheField:"profile_image_external",isMultiple:!1}]},R=input.config();M(N,R);})();
