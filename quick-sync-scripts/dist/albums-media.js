"use strict";(()=>{var v="API-SYNC";function I(t,i=v){if(!t||!t.includes(":"))throw new Error(`Secret "${i}" must be "user:app-password".`);return Buffer.from(t).toString("base64")}var p=t=>console.log(`[${new Date().toISOString()}]`,t),A="API-SYNC";async function k(t){var c,o;let i=await fetch(t.url);if(!i.ok)throw new Error(`\u2198 download ${t.url} \u2192 HTTP ${i.status}`);return{blob:await i.blob(),filename:(c=t.filename)!=null?c:"file",contentType:(o=i.headers.get("content-type"))!=null?o:"application/octet-stream",srcUrl:t.url}}async function U(t,i,{blob:c,filename:o,contentType:m},d){p(`Uploading ${o}${d?` for record ${d}`:""} \u2026`);try{let n=await fetch(t,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":m,"Content-Disposition":`attachment; filename="${o}"`},body:c}),a=await n.json();if(!n.ok||!(a!=null&&a.id))throw new Error(`\u2197 WP upload failed ${n.status}: ${JSON.stringify(a).slice(0,200)}`);return p(`\u2705 Uploaded ${o} \u2192 ${a.source_url} (wpId: ${a.id})`),{id:String(a.id),url:a.source_url}}catch(n){throw console.error(`\u274C Upload failed ${o}${d?` for record ${d}`:""}: ${n.message}`),n}}async function x(t,i,c,o,m,d){var T,_,E,h,$,C,w;let n=(T=t.getCellValue(i.attachmentField))!=null?T:[],a=(_=t.getCellValue(i.wpIdField))!=null?_:"",F=(E=t.getCellValue(i.wpUrlField))!=null?E:"",f=(h=t.getCellValue(i.airtableCacheField))!=null?h:"",g=(f!=null?f:"").split(",").filter(Boolean),S=i.externalUrlField?((($=t.getCellValueAsString)==null?void 0:$.call(t,i.externalUrlField))||"").trim():"";if(n.length===0&&S)return{wpIds:null,wpUrls:S,cacheUrls:null,changed:S!==F};if(n.length===0)return a||F||f?{wpIds:null,wpUrls:null,cacheUrls:null,changed:!0}:{changed:!1};if(!i.isMultiple){let l=n[0];if(g.includes(l.id)&&a)return p(`\u21A9\uFE0F Reusing ${(C=l.filename)!=null?C:"file"} (wpId: ${a})`),{changed:!1};try{let{blob:s,filename:u,contentType:y}=await k(l),{id:e,url:r}=await U(c,o,{blob:s,filename:u,contentType:y},m);return{wpIds:e,wpUrls:r,cacheUrls:l.id,changed:!0}}catch(s){return d&&d(s),p(`\u26A0\uFE0F  single-upload failed ${l.url}: ${s.message}`),{changed:!1}}}if(i.isMultiple){let l=[];for(let s of n){if(g.includes(s.id)){p(`\u21A9\uFE0F Reusing ${(w=s.filename)!=null?w:"file"}\u2026`);continue}try{let{blob:u,filename:y,contentType:e}=await k(s),{id:r,url:b}=await U(c,o,{blob:u,filename:y,contentType:e},m);l.push({id:r,url:b,airtableId:s.id})}catch(u){d&&d(u),p(`\u274C  multi\u2011upload failed ${s.url}: ${u.message}`)}}if(l.length||n.some(s=>g.includes(s.id))){let s=n.filter(e=>g.includes(e.id)).map(e=>e.id),u=a.split(",").filter(Boolean).filter((e,r)=>{var b;return g.includes((b=n[r])==null?void 0:b.id)}),y=F.split(",").filter(Boolean).filter((e,r)=>{var b;return g.includes((b=n[r])==null?void 0:b.id)});return{wpIds:[...u,...l.map(e=>e.id)].join(","),wpUrls:[...y,...l.map(e=>e.url)].join(","),cacheUrls:[...s,...l.map(e=>e.airtableId)].join(","),changed:!0}}return{changed:!1}}return{changed:!1}}async function M(t,i){var s,u,y;let c=!1,{airtableTable:o,envMediaEndpoints:m,imageFields:d,lastModifiedField:n,publishTimestampField:a,secretName:F=A}=t,{recordId:f,env:g}=i;if(!f)throw new Error("Automation must pass {recordId}.");if(!g||!m[g]){let e=Object.keys(m).join(", ");throw new Error(`Input variable "env" is missing or invalid. Please provide one of the following: ${e}`)}let S=m[g],T=I(await input.secret(F),F),_=base.getTable(o),E=[n,a,...d.flatMap(e=>[e.attachmentField,e.wpIdField,e.wpUrlField,e.airtableCacheField])],h=await _.selectRecordAsync(f,{fields:E});if(!h)throw new Error(`Record ${f} not found.`);let $=h.getCellValue(n),C=h.getCellValue(a);if($&&C&&Date.parse($)<=Date.parse(C)){p("\u23ED\xA0Images unchanged since last sync \u2013 skipping");return}let w={},l=!1;for(let e of d)try{let r=await x(h,e,S,T,f,b=>{c=!0});r&&r.changed&&(w[e.wpIdField]=(s=r.wpIds)!=null?s:null,w[e.wpUrlField]=(u=r.wpUrls)!=null?u:null,w[e.airtableCacheField]=(y=r.cacheUrls)!=null?y:null,l=!0)}catch(r){c=!0,p(`\u26A0\uFE0F  ${e.attachmentField}: ${r.message}`)}l?(c?p("\u26A0\uFE0F  Skipping timestamp because at least one upload failed"):w[a]=new Date().toISOString(),await _.updateRecordAsync(h,w),p("\u2705\xA0Media sync complete & fields updated")):p("\u2714\xA0No media changes detected \u2013 nothing to write")}var N=input.config(),R={airtableTable:"Albums",envMediaEndpoints:{prod:"https://four12global.com/wp-json/wp/v2/media",staging:"https://wordpress-1204105-5660147.cloudwaysapps.com/wp-json/wp/v2/media"},lastModifiedField:"media_last_modified",publishTimestampField:"media_publish_timestamp",imageFields:[{attachmentField:"featured_image_attachment",wpIdField:"featured_image_wp_id",wpUrlField:"featured_image_link",airtableCacheField:"featured_image_external",isMultiple:!1},{attachmentField:"chord_sheet_attachment",wpIdField:"chord_sheet_wp_id",wpUrlField:"chord_sheet_link",airtableCacheField:"chord_sheet_external",isMultiple:!1}]};M(R,N);})();
